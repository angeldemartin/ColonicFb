---
title: "ColonicFb"
author: "A.DeMartin"
date: "2024-12-16"
output: 
  html_document:
    keep_md: true
    toc: true
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

## load packages
```{r load packages, warning=FALSE, include=FALSE}
library(ExploreSCdataSeurat3)
library(runSeurat3)
library(Seurat)
library(ggpubr)
library(pheatmap)
library(SingleCellExperiment)
library(dplyr)
library(tidyverse)
library(viridis)
library(muscat)
library(circlize)
library(destiny)
library(scater)
library(metap)
library(multtest)
library(clusterProfiler)
library(org.Mm.eg.db)
library(msigdbr)
library(enrichplot)
library(DOSE)
library(grid)
library(gridExtra)
library(ggupset)
library(VennDiagram)
library(NCmisc)
```

## load file
```{r load merged file}
##load merged file 
fileNam <- "/Users/immbio/Desktop/Project/Angelina/ColonicFb/data/allmerged_seurat.rds"
seuratM <- readRDS(fileNam)
```

## set color vectors 
```{r color vectors}

## set vector for cond
colcond <- c("#628395","#BF782D", "#B45B5C")
names(colcond) <- c("untreated", "crod", "DSS")

## set vector for dataset
coldataset <- c("#628395","#BF782D","#B45B5C")
names(coldataset) <- c("372561_14-14_20241203_Mu_colonicFb_untreated", "372561_15-15_20241203_Mu_colonicFb_cond1", "372561_16-16_20241209_Mu_colonicFb_cond2")

colpal <- c("#355C7D","#628395","#99B898","#66C2A5","#E84A5F","#B45B5C","#BF782D","#6C5B7B", "#C06C84", "#c7eae5","#904D39", "#67001f","#0F1F38","#8E9B97")
names(colpal) <- c("0","3","2", "6", "1", "5", "4", "7","8", "11", "9", "12", "10", "13")

colclusterName <- c("#355C7D","#628395","#99B898","#66C2A5","#E84A5F","#B45B5C","#BF782D","#6C5B7B", "#C06C84", "#c7eae5","#904D39", "#67001f","#0F1F38","#8E9B97")
names(colclusterName) <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","EpC","Cycling")
```

## calculate cluster marker genes
```{r marker genes, include=TRUE, eval=FALSE}
##cluster marker
Idents(seuratM) <- seuratM$RNA_snn_res.0.25
markerGenes <- FindAllMarkers(seuratM, only.pos=T)  %>% 
  dplyr::filter(p_val_adj < 0.01)

#save table
write.table(markerGenes, 
            file= "/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/markerGenes_res0.25",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## extract genes for heatmap
```{r extract genes top marker genes}
## load DEGenesFbcond3
markerGenes <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/markerGenes_res0.25", header = TRUE, sep = "\t")

##adjust table
markerGenes <- markerGenes %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

marker_0 <- dplyr::filter(markerGenes, cluster == "0") %>%     # Filter rows where cluster is "0"
  slice_min(order_by = p_val_adj, n = 10)  %>% # Select the 10 rows with the smallest p_val_adj
  slice_max(order_by = avg_log2FC, n = 10) # Select the 10 rows with the smallest p_val_adj

marker_1 <- dplyr::filter(markerGenes, cluster == "1") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_2 <- dplyr::filter(markerGenes, cluster == "2") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_3 <- dplyr::filter(markerGenes, cluster == "3") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_4 <- dplyr::filter(markerGenes, cluster == "4") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_5 <- dplyr::filter(markerGenes, cluster == "5") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_6 <- dplyr::filter(markerGenes, cluster == "6") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_7 <- dplyr::filter(markerGenes, cluster == "7") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_8 <- dplyr::filter(markerGenes, cluster == "8") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_9 <- dplyr::filter(markerGenes, cluster == "9") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_10 <- dplyr::filter(markerGenes, cluster == "10") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_11 <- dplyr::filter(markerGenes, cluster == "11") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_12 <- dplyr::filter(markerGenes, cluster == "12") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_13 <- dplyr::filter(markerGenes, cluster == "13") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

# List of data frames
df_list <- list(marker_0, marker_1, marker_2, marker_3, marker_4, marker_5, marker_6, marker_7, marker_8, marker_9, marker_10, marker_11, marker_12, marker_13)
marker_all <- reduce(df_list, full_join)
mGenes <- as.vector(marker_all$Gene)
```

## average heatmap top10 marker
```{r avg heatmap top10 cluster marker, fig.width=10, fig.height=22}
Idents(seuratM) <- seuratM$clusterName
seurat <- seuratM
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(colnames(logNormExpresMa))
    #dplyr::mutate(celltype=colnames(logNormExpresMa))
  #colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[1] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
    ordVec <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","EpC","Cycling")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
genesPlot <- data.frame(gene=mGenes)

levels(seurat)
colVec <- colclusterName
# colVec <- c(colPal, colPal, colPal)
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

## dotplot marker cluster
```{r dotplot marker cluster, fig.height=4, fig.width=9}
genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("Mki67","Epcam","Ptprc","Ano1","Plp1","Acta2","Bmp5","Adamdec1","Pdgfra","Pi16","Cd81","Cd34","Pdpn")) %>% left_join(., genes, by="geneID")

DotPlot(seuratM, features = selGenes, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## dotplot marker cluster+cond
```{r dotplot marker cluster plus cond, fig.height=5, fig.width=14}
Idents(seuratM) <- seuratM$clusterName_cond

genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("Mki67","Epcam","Ptprc","Ano1","Plp1","Acta2","Bmp5","Adamdec1","Pdgfra","Pi16","Cd81","Cd34","Pdpn")) %>% left_join(., genes, by="geneID")

DotPlot(seuratM, features = selGenes, group.by= "clusterName_cond") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## feature plots fb maker genes
```{r feature plots fb}
## plot feature
FeaturePlot(seuratM, features = "ENSMUSG00000020717.Pecam1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000045394.Epcam", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000026395.Ptprc", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000039542.Ncam1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000031004.Mki67", cols = c("lightgrey", "#BE3144"), pt.size = 1)

FeaturePlot(seuratM, features = "ENSMUSG00000028583.Pdpn", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000029231.Pdgfra", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000035783.Acta2", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000037706.Cd81", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000016494.Cd34", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000022057.Adamdec1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
```

## calculate DE genes cond
```{r cond DE genes, include=TRUE, eval=FALSE}
##cluster marker
Idents(seuratM) <- seuratM$cond
markerGenes <- FindAllMarkers(seuratM, only.pos=T)  %>% 
  dplyr::filter(p_val_adj < 0.01)

#save table
write.table(markerGenes, 
            file= "/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenes_cond",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## GSEA untreated
```{r GSEA untreated, fig.width=10, fig.height=10}
## load DEGenesFbcond3
DEGenes <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenes_cond", header = TRUE, sep = "\t")

##adjust table
DEGenes <- DEGenes %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

DEuntreated <- DEGenes %>% dplyr::filter(cluster == "untreated")
##GSEA untreated
egountreated<- enrichGO(gene = unique(DEuntreated$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egountreated <- setReadable(egountreated, OrgDb = org.Mm.eg.db)
dotplot(egountreated, showCategory=30)
```

## GSEA c.rod
```{r GSEA crod, fig.width=10, fig.height=10}
DEcrod <- DEGenes %>% dplyr::filter(cluster == "crod")
##GSEA crod
egocrod<- enrichGO(gene = unique(DEcrod$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egocrod <- setReadable(egocrod, OrgDb = org.Mm.eg.db)
dotplot(egocrod, showCategory=30)
```

## GSEA DSS
```{r GSEA DSS, fig.width=10, fig.height=10}
DEDSS <- DEGenes %>% dplyr::filter(cluster == "DSS")
##GSEA DSS
egoDSS<- enrichGO(gene = unique(DEDSS$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egoDSS <- setReadable(egoDSS, OrgDb = org.Mm.eg.db)
dotplot(egoDSS, showCategory=30)
```

## cluster top 100 DE genes
```{r cluster top 100 DE genes}
Idents(seuratM) <- seuratM$cond
#top DE genes PdgfraloFb1
seuratPdgfraloFb1 <- subset(seuratM, clusterName == "PdgfraloFb1")
table(seuratPdgfraloFb1$clusterName)
levels(seuratPdgfraloFb1)

DEGenesPdgfraloFb1 <- FindAllMarkers(seuratPdgfraloFb1,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "PdgfraloFb1")
DEGenesPdgfraloFb1top <- DEGenesPdgfraloFb1 %>% top_n (200, avg_log2FC)

#top DE genes PdgfraloFb2
seuratPdgfraloFb2 <- subset(seuratM, clusterName == "PdgfraloFb2")
table(seuratPdgfraloFb2$clusterName)
levels(seuratPdgfraloFb2)

DEGenesPdgfraloFb2 <- FindAllMarkers(seuratPdgfraloFb2,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "PdgfraloFb2")
DEGenesPdgfraloFb2top <- DEGenesPdgfraloFb2 %>% top_n (200, avg_log2FC)

#top DE genes Trophocytes1
seuratTrophocytes1 <- subset(seuratM, clusterName == "Trophocytes1")
table(seuratTrophocytes1$clusterName)
levels(seuratTrophocytes1)

DEGenesTrophocytes1 <- FindAllMarkers(seuratTrophocytes1,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "Trophocytes1")
DEGenesTrophocytes1top <- DEGenesTrophocytes1 %>% top_n (200, avg_log2FC)

#top DE genes Trophocytes2
seuratTrophocytes2 <- subset(seuratM, clusterName == "Trophocytes2")
table(seuratTrophocytes2$clusterName)
levels(seuratTrophocytes2)

DEGenesTrophocytes2 <- FindAllMarkers(seuratTrophocytes2,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "Trophocytes2")
DEGenesTrophocytes2top <- DEGenesTrophocytes2 %>% top_n (200, avg_log2FC)

DEGenesAll <- full_join(DEGenesPdgfraloFb1top, DEGenesPdgfraloFb2top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTrophocytes1top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTrophocytes2top)

#top DE genes Telocytes/Fibro2
seuratTelocytes <- subset(seuratM, clusterName == "Telocytes/Fibro2")
table(seuratTelocytes$clusterName)
levels(seuratTelocytes)

DEGenesTelocytes <- FindAllMarkers(seuratTelocytes,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "Telocytes/Fibro2")
DEGenesTelocytestop <- DEGenesTelocytes %>% top_n (200, avg_log2FC)

#top DE genes PdgfrahiFb
seuratPdgfrahiFb <- subset(seuratM, clusterName == "PdgfrahiFb")
table(seuratPdgfrahiFb$clusterName)
levels(seuratPdgfrahiFb)

DEGenesPdgfrahiFb <- FindAllMarkers(seuratPdgfrahiFb,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "PdgfrahiFb")
DEGenesPdgfrahiFbtop <- DEGenesPdgfrahiFb %>% top_n (200, avg_log2FC)

#top DE genes Myocytes
seuratMyocytes <- subset(seuratM, clusterName == "Myocytes")
table(seuratMyocytes$clusterName)
levels(seuratMyocytes)

DEGenesMyocytes <- FindAllMarkers(seuratMyocytes,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "Myocytes")
DEGenesMyocytestop <- DEGenesMyocytes %>% top_n (200, avg_log2FC)

DEGenesAll <- full_join(DEGenesPdgfraloFb1top, DEGenesPdgfraloFb2top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTrophocytes1top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTrophocytes2top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTelocytestop)
DEGenesAll <- full_join(DEGenesAll, DEGenesPdgfrahiFbtop)
DEGenesAll <- full_join(DEGenesAll, DEGenesMyocytestop)
```

## distribution of log2FC of top 200 cw DE genes
```{r top 100 DE genes, fig.width=8, fig.height=4}
ggdensity(DEGenesAll, x = "avg_log2FC", add= "median", rug = TRUE, color = "celltype", fill = "celltype", palette = colclusterName)

ggviolin(DEGenesAll, x = "celltype", y = "avg_log2FC", fill = "celltype", palette = colclusterName, add = "median_iqr")

ggboxplot(DEGenesAll, x = "celltype", y = "avg_log2FC", color = "celltype", palette = colclusterName ,add = "jitter")
```


## dotplot RIG-I signaling pathway genes
```{r dotplot RIG-I, fig.height=4, fig.width=12}
Idents(seuratM) <- seuratM$clusterName_cond

genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("Ankrd17","Zc3hav1","Ddx60","Rigi","Pum2","Pum1","Nploc4","Usp15","Lsm14a","Nlrx1","Oasl1")) %>% left_join(., genes, by="geneID")

DotPlot(seuratM, features = selGenes, group.by= "clusterName_cond") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## dotplot activation of innate immune response
```{r dotplot innate immune response, fig.height=22, fig.width=12}
Idents(seuratM) <- seuratM$clusterName_cond

genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

egoDSS <- dplyr::filter(egoDSS@result, egoDSS@result$Description =="activation of innate immune response")
g1 <- egoDSS$geneID
Str <- (g1)
strSub <- strsplit(Str, "/")
df <- as.data.frame(strSub)
colnames(df) <- c ("geneID")

selGenes <- data.frame(geneID=df$geneID) %>% left_join(., genes, by="geneID")
DotPlot(seuratM, features = selGenes, group.by= "clusterName_cond") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## session info
```{r date and session info}
date()
sessionInfo()
```
