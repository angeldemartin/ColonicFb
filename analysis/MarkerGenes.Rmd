---
title: "ColonicFb"
author: "A.DeMartin"
date: "2024-12-16"
output: 
  html_document:
    keep_md: true
    toc: true
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

## load packages
```{r load packages, warning=FALSE, include=FALSE}
library(ExploreSCdataSeurat3)
library(runSeurat3)
library(Seurat)
library(ggpubr)
library(pheatmap)
library(SingleCellExperiment)
library(dplyr)
library(tidyverse)
library(viridis)
library(muscat)
library(circlize)
library(destiny)
library(scater)
library(metap)
library(multtest)
library(clusterProfiler)
library(org.Mm.eg.db)
library(msigdbr)
library(enrichplot)
library(DOSE)
library(grid)
library(gridExtra)
library(ggupset)
library(VennDiagram)
library(NCmisc)
```

## load file
```{r load merged file}
##load merged file 
fileNam <- "/Users/immbio/Desktop/Project/Angelina/ColonicFb/data/allmerged_seurat.rds"
seuratM <- readRDS(fileNam)
```

## set color vectors 
```{r color vectors}

## set vector for cond
colcond <- c("#202547","#99B898", "#BE3144")
names(colcond) <- c("untreated", "crod", "DSS")

## set vector for dataset
coldataset <- c("#202547","#99B898", "#BE3144")
names(coldataset) <- c("372561_14-14_20241203_Mu_colonicFb_untreated", "372561_15-15_20241203_Mu_colonicFb_cond1", "372561_16-16_20241209_Mu_colonicFb_cond2")

colpal <- c("#355C7D","#628395","#99B898","#66C2A5","#E84A5F","#B45B5C","#BF782D","#6C5B7B", "#C06C84", "#c7eae5","#904D39", "#67001f","#0F1F38","#8E9B97")
names(colpal) <- c("0","3","2", "6", "1", "5", "4", "7","8", "11", "9", "12", "10", "13")

colclusterName <- c("#355C7D","#628395","#99B898","#66C2A5","#E84A5F","#B45B5C","#BF782D","#6C5B7B", "#C06C84", "#c7eae5","#904D39", "#67001f","#0F1F38","#8E9B97")
names(colclusterName) <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","IEC","Cycling")


#c("#67001f", "#D53E4F", "#f4a582", "#FEE08B", "#003c30","#01665e","#66C2A5", "#3288BD","#BEAED4", "#c7eae5","#355C7D","#202547","#B45B5C","#8c510a")
#c("#dfc27d","#BE3144","#202547","#355C7D","#779d8d")
#c("#202547","#BE3144")
```

## calculate cluster marker genes
```{r marker genes, include=TRUE, eval=FALSE}
##cluster marker
Idents(seuratM) <- seuratM$RNA_snn_res.0.25
markerGenes <- FindAllMarkers(seuratM, only.pos=T)  %>% 
  dplyr::filter(p_val_adj < 0.01)

#save table
write.table(markerGenes, 
            file= "/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/markerGenes_res0.25",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## extract genes for heatmap
```{r extract genes top marker genes}
## load DEGenesFbcond3
markerGenes <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/markerGenes_res0.25", header = TRUE, sep = "\t")

##adjust table
markerGenes <- markerGenes %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

marker_0 <- dplyr::filter(markerGenes, cluster == "0") %>%     # Filter rows where cluster is "0"
  slice_min(order_by = p_val_adj, n = 10)  %>% # Select the 10 rows with the smallest p_val_adj
  slice_max(order_by = avg_log2FC, n = 10) # Select the 10 rows with the smallest p_val_adj

marker_1 <- dplyr::filter(markerGenes, cluster == "1") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_2 <- dplyr::filter(markerGenes, cluster == "2") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_3 <- dplyr::filter(markerGenes, cluster == "3") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_4 <- dplyr::filter(markerGenes, cluster == "4") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_5 <- dplyr::filter(markerGenes, cluster == "5") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_6 <- dplyr::filter(markerGenes, cluster == "6") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_7 <- dplyr::filter(markerGenes, cluster == "7") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10) 

marker_8 <- dplyr::filter(markerGenes, cluster == "8") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_9 <- dplyr::filter(markerGenes, cluster == "9") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_10 <- dplyr::filter(markerGenes, cluster == "10") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_11 <- dplyr::filter(markerGenes, cluster == "11") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_12 <- dplyr::filter(markerGenes, cluster == "12") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

marker_13 <- dplyr::filter(markerGenes, cluster == "13") %>%  
  slice_min(order_by = p_val_adj, n = 10)  %>% 
  slice_max(order_by = avg_log2FC, n = 10)

# List of data frames
df_list <- list(marker_0, marker_1, marker_2, marker_3, marker_4, marker_5, marker_6, marker_7, marker_8, marker_9, marker_10, marker_11, marker_12, marker_13)
marker_all <- reduce(df_list, full_join)
mGenes <- as.vector(marker_all$Gene)
```

## average heatmap top10 marker
```{r avg heatmap top10 cluster marker, fig.width=10, fig.height=22}
Idents(seuratM) <- seuratM$clusterName
seurat <- seuratM
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(colnames(logNormExpresMa))
    #dplyr::mutate(celltype=colnames(logNormExpresMa))
  #colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[1] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
    ordVec <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","IEC","Cycling")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
genesPlot <- data.frame(gene=mGenes)

levels(seurat)
colVec <- colclusterName
# colVec <- c(colPal, colPal, colPal)
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

## dotplot marker cluster
```{r dotplot marker cluster, fig.height=4, fig.width=9}
genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("Mki67","Epcam","Ptprc","Ano1","Plp1","Acta2","Bmp5","Adamdec1","Pdgfra","Pi16","Cd81","Cd34","Pdpn")) %>% left_join(., genes, by="geneID")

DotPlot(seuratM, features = selGenes, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## dotplot marker cluster fb only
```{r dotplot marker cluster fb only, fig.height=4, fig.width=9}
###subset fb 
seuratFb <- subset(seuratM, clusterName %in% c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2"))

genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("Ano1","Plp1","Acta2","Bmp5","Adamdec1","Pdgfra","Pi16","Cd81","Cd34","Pdpn")) %>% left_join(., genes, by="geneID")
DotPlot(seuratFb, features = selGenes, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()

selGenes <- data.frame(geneID=c("Wnt2b","Ccn2","Bmp4","Bmp6","Sfrp2","Col15a1","Grem1","Igfbp3")) %>% left_join(., genes, by="geneID")
DotPlot(seuratFb, features = selGenes, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## dotplot marker cluster+cond
```{r dotplot marker cluster plus cond, fig.height=5, fig.width=14}
Idents(seuratM) <- seuratM$clusterName_cond

genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("Mki67","Epcam","Ptprc","Ano1","Plp1","Acta2","Bmp5","Adamdec1","Pdgfra","Pi16","Cd81","Cd34","Pdpn")) %>% left_join(., genes, by="geneID")

DotPlot(seuratM, features = selGenes, group.by= "clusterName_cond") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## feature plots fb maker genes
```{r feature plots fb}
## plot feature
FeaturePlot(seuratM, features = "ENSMUSG00000020717.Pecam1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000045394.Epcam", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000026395.Ptprc", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000039542.Ncam1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000031004.Mki67", cols = c("lightgrey", "#BE3144"), pt.size = 1)

FeaturePlot(seuratM, features = "ENSMUSG00000028583.Pdpn", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000029231.Pdgfra", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000035783.Acta2", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000037706.Cd81", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000016494.Cd34", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratM, features = "ENSMUSG00000022057.Adamdec1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
```

## feature plots fb maker genes fb only
```{r feature plots fb only}
## plot feature
FeaturePlot(seuratFb, features = "ENSMUSG00000020717.Pecam1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000045394.Epcam", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000026395.Ptprc", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000039542.Ncam1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000031004.Mki67", cols = c("lightgrey", "#BE3144"), pt.size = 1)

FeaturePlot(seuratFb, features = "ENSMUSG00000028583.Pdpn", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000029231.Pdgfra", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000035783.Acta2", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000037706.Cd81", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000016494.Cd34", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000022057.Adamdec1", cols = c("lightgrey", "#BE3144"), pt.size = 1)
```

## calculate DE genes cond
```{r cond DE genes, include=TRUE, eval=FALSE}
##cluster marker
Idents(seuratM) <- seuratM$cond
markerGenes <- FindAllMarkers(seuratM, only.pos=T)  %>% 
  dplyr::filter(p_val_adj < 0.01)

#save table
write.table(markerGenes, 
            file= "/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenes_cond",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## load DE genes cond
```{r load DE genes, fig.width=10, fig.height=10}
## load DEGenes cond3
DEGenes <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenes_cond", header = TRUE, sep = "\t")

##adjust table
DEGenes <- DEGenes %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))
```

## GSEA untreated
```{r GSEA untreated, fig.width=10, fig.height=10}
DEuntreated <- DEGenes %>% dplyr::filter(cluster == "untreated")
##GSEA untreated
egountreated<- enrichGO(gene = unique(DEuntreated$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egountreated <- setReadable(egountreated, OrgDb = org.Mm.eg.db)
dotplot(egountreated, showCategory=30)
```

## GSEA c.rod
```{r GSEA crod, fig.width=10, fig.height=10}
DEcrod <- DEGenes %>% dplyr::filter(cluster == "crod")
##GSEA crod
egocrod<- enrichGO(gene = unique(DEcrod$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egocrod <- setReadable(egocrod, OrgDb = org.Mm.eg.db)
dotplot(egocrod, showCategory=30)
```

## GSEA DSS
```{r GSEA DSS, fig.width=10, fig.height=10}
DEDSS <- DEGenes %>% dplyr::filter(cluster == "DSS")
##GSEA DSS
egoDSS<- enrichGO(gene = unique(DEDSS$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egoDSS <- setReadable(egoDSS, OrgDb = org.Mm.eg.db)
dotplot(egoDSS, showCategory=30)
```

## cluster top 100 DE genes
```{r cluster top 100 DE genes}
Idents(seuratM) <- seuratM$cond
#top DE genes PdgfraloFb1
seuratPdgfraloFb1 <- subset(seuratM, clusterName == "PdgfraloFb1")
table(seuratPdgfraloFb1$clusterName)
levels(seuratPdgfraloFb1)

DEGenesPdgfraloFb1 <- FindAllMarkers(seuratPdgfraloFb1,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "PdgfraloFb1")
DEGenesPdgfraloFb1top <- DEGenesPdgfraloFb1 %>% top_n (200, avg_log2FC)

#top DE genes PdgfraloFb2
seuratPdgfraloFb2 <- subset(seuratM, clusterName == "PdgfraloFb2")
table(seuratPdgfraloFb2$clusterName)
levels(seuratPdgfraloFb2)

DEGenesPdgfraloFb2 <- FindAllMarkers(seuratPdgfraloFb2,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "PdgfraloFb2")
DEGenesPdgfraloFb2top <- DEGenesPdgfraloFb2 %>% top_n (200, avg_log2FC)

#top DE genes Trophocytes1
seuratTrophocytes1 <- subset(seuratM, clusterName == "Trophocytes1")
table(seuratTrophocytes1$clusterName)
levels(seuratTrophocytes1)

DEGenesTrophocytes1 <- FindAllMarkers(seuratTrophocytes1,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "Trophocytes1")
DEGenesTrophocytes1top <- DEGenesTrophocytes1 %>% top_n (200, avg_log2FC)

#top DE genes Trophocytes2
seuratTrophocytes2 <- subset(seuratM, clusterName == "Trophocytes2")
table(seuratTrophocytes2$clusterName)
levels(seuratTrophocytes2)

DEGenesTrophocytes2 <- FindAllMarkers(seuratTrophocytes2,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "Trophocytes2")
DEGenesTrophocytes2top <- DEGenesTrophocytes2 %>% top_n (200, avg_log2FC)

DEGenesAll <- full_join(DEGenesPdgfraloFb1top, DEGenesPdgfraloFb2top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTrophocytes1top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTrophocytes2top)

#top DE genes Telocytes/Fibro2
seuratTelocytes <- subset(seuratM, clusterName == "Telocytes/Fibro2")
table(seuratTelocytes$clusterName)
levels(seuratTelocytes)

DEGenesTelocytes <- FindAllMarkers(seuratTelocytes,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "Telocytes/Fibro2")
DEGenesTelocytestop <- DEGenesTelocytes %>% top_n (200, avg_log2FC)

#top DE genes PdgfrahiFb
seuratPdgfrahiFb <- subset(seuratM, clusterName == "PdgfrahiFb")
table(seuratPdgfrahiFb$clusterName)
levels(seuratPdgfrahiFb)

DEGenesPdgfrahiFb <- FindAllMarkers(seuratPdgfrahiFb,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "PdgfrahiFb")
DEGenesPdgfrahiFbtop <- DEGenesPdgfrahiFb %>% top_n (200, avg_log2FC)

#top DE genes Myocytes
seuratMyocytes <- subset(seuratM, clusterName == "Myocytes")
table(seuratMyocytes$clusterName)
levels(seuratMyocytes)

DEGenesMyocytes <- FindAllMarkers(seuratMyocytes,only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) %>% mutate(celltype = "Myocytes")
DEGenesMyocytestop <- DEGenesMyocytes %>% top_n (200, avg_log2FC)

DEGenesAll <- full_join(DEGenesPdgfraloFb1top, DEGenesPdgfraloFb2top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTrophocytes1top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTrophocytes2top)
DEGenesAll <- full_join(DEGenesAll, DEGenesTelocytestop)
DEGenesAll <- full_join(DEGenesAll, DEGenesPdgfrahiFbtop)
DEGenesAll <- full_join(DEGenesAll, DEGenesMyocytestop)
```

## distribution of log2FC of top 200 cw DE genes
```{r top 100 DE genes, fig.width=8, fig.height=4}
ggdensity(DEGenesAll, x = "avg_log2FC", add= "median", rug = TRUE, color = "celltype", fill = "celltype", palette = colclusterName)

ggviolin(DEGenesAll, x = "celltype", y = "avg_log2FC", fill = "celltype", palette = colclusterName, add = "median_iqr")

ggboxplot(DEGenesAll, x = "celltype", y = "avg_log2FC", color = "celltype", palette = colclusterName ,add = "jitter")
```


## dotplot RIG-I signaling pathway genes fb
```{r dotplot RIG-I fb, fig.height=4, fig.width=12}
Idents(seuratFb) <- seuratFb$clusterName_cond

genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("Ankrd17","Zc3hav1","Ddx60","Rigi","Pum2","Pum1","Nploc4","Usp15","Lsm14a","Nlrx1","Oasl1")) %>% left_join(., genes, by="geneID")

DotPlot(seuratFb, features = selGenes, group.by= "clusterName_cond") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## dotplot activation of innate immune response
```{r dotplot innate immune response, fig.height=22, fig.width=12}
Idents(seuratFb) <- seuratM$clusterName_cond

genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

egoDSS <- dplyr::filter(egoDSS@result, egoDSS@result$Description =="activation of innate immune response")
g1 <- egoDSS$geneID
Str <- (g1)
strSub <- strsplit(Str, "/")
df <- as.data.frame(strSub)
colnames(df) <- c ("geneID")

selGenes <- data.frame(geneID=df$geneID) %>% left_join(., genes, by="geneID")
DotPlot(seuratFb, features = selGenes, group.by= "clusterName_cond") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## subset Adamdec+ (PdgfraloFb2 and Telocytes/Fibro2)
```{r subset Adamdec+}
seuratA <- subset(seuratM, clusterName %in% c("PdgfraloFb2", "Telocytes/Fibro2"))
table(seuratA$clusterName)
```


## calculate DE genes cond Adamdec1
```{r DE genes DSS in Adamdec1, include=TRUE, eval=FALSE}
##DE genes DSS in Adamdec1+
Idents(seuratA) <- seuratA$cond
levels(seuratA)
DEGenesAdamdec <- FindAllMarkers(seuratA, only.pos=T)  %>% 
  dplyr::filter(p_val_adj < 0.01)

#save table
write.table(DEGenesAdamdec, 
            file= "/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenesAdamdec1_cond",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## extract genes for heatmap DE DSS
```{r extract genes top DE DSS genes}
## load DEGenesAdamdec1
DEGenesAdamdec <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenesAdamdec1_cond", header = TRUE, sep = "\t")

##adjust table
DEGenesAdamdec <- DEGenesAdamdec %>%
  mutate(Gene=gsub("^[^\\.]*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

DE_DSS <- dplyr::filter(DEGenesAdamdec, cluster == "DSS") %>%     # Filter rows where cluster is "DSS"
  slice_min(order_by = p_val_adj, n = 100)  #%>% # Select the 10 rows with the smallest p_val_adj
  #slice_max(order_by = avg_log2FC, n = 25) # Select the 10 rows with the smallest p_val_adj

# List of data frames
mGenes <- as.vector(DE_DSS$Gene)
mGenes <- mGenes[mGenes != "CT010467.1"]
```

## average heatmap top100 DE genes DSS
```{r avg heatmap top100 DE DSS, fig.width=10, fig.height=18}
Idents(seuratFb) <- seuratFb$clusterName_cond
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^.*?_)","",celltype))
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(_.*$)","",celltype))
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
   # ordVec <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","IEC","Cycling")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=mGenes)

levels(seurat)
colVec <- colclusterName
# colVec <- c(colPal, colPal, colPal)
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

## extract genes for heatmap DE untreated
```{r extract genes top DE untreated genes}
## load DEGenesAdamdec1
DEGenesAdamdec <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenesAdamdec1_cond", header = TRUE, sep = "\t")

##adjust table
DEGenesAdamdec <- DEGenesAdamdec %>%
  mutate(Gene=gsub("^[^\\.]*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

DE_untreated <- dplyr::filter(DEGenesAdamdec, cluster == "untreated") %>% 
  slice_min(order_by = p_val_adj, n = 100)  #%>% # Select the 10 rows with the smallest p_val_adj
  #slice_max(order_by = avg_log2FC, n = 25) # Select the 10 rows with the smallest p_val_adj

# List of data frames
mGenes <- as.vector(DE_untreated$Gene)
```

## average heatmap top100 DE genes untereated
```{r avg heatmap top100 DE untreated, fig.width=10, fig.height=18}
Idents(seuratFb) <- seuratFb$clusterName_cond
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^.*?_)","",celltype))
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(_.*$)","",celltype))
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
   # ordVec <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","IEC","Cycling")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=mGenes)

levels(seurat)
colVec <- colclusterName
# colVec <- c(colPal, colPal, colPal)
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

## extract genes for heatmap DE crod
```{r extract genes top DE crod genes}
## load DEGenesAdamdec1
DEGenesAdamdec <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenesAdamdec1_cond", header = TRUE, sep = "\t")

##adjust table
DEGenesAdamdec <- DEGenesAdamdec %>%
  mutate(Gene=gsub("^[^\\.]*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

DE_crod <- dplyr::filter(DEGenesAdamdec, cluster == "crod") %>% 
  slice_min(order_by = p_val_adj, n = 100)  #%>% # Select the 10 rows with the smallest p_val_adj
  #slice_max(order_by = avg_log2FC, n = 25) # Select the 10 rows with the smallest p_val_adj

# List of data frames
mGenes <- as.vector(DE_untreated$Gene)
```

## average heatmap top100 DE genes crod
```{r avg heatmap top100 DE crod, fig.width=10, fig.height=18}
Idents(seuratFb) <- seuratFb$clusterName_cond
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^.*?_)","",celltype))
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(_.*$)","",celltype))
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
   # ordVec <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","IEC","Cycling")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=mGenes)

levels(seurat)
colVec <- colclusterName
# colVec <- c(colPal, colPal, colPal)
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```




## GSEA DSS Adamdec1
```{r GSEA DSS Adamdec1, fig.width=10, fig.height=10}
## load DEGenesAdamdec1
DEGenesAdamdec <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenesAdamdec1_cond", header = TRUE, sep = "\t")

DEGenesAdamdec <- DEGenesAdamdec %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

DEDSSAdamdec1 <- DEGenesAdamdec %>% dplyr::filter(cluster == "DSS")
##GSEA DSS
egoDSSAdamdec1<- enrichGO(gene = unique(DEDSSAdamdec1$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egoDSSAdamdec1 <- setReadable(egoDSSAdamdec1, OrgDb = org.Mm.eg.db)
dotplot(egoDSSAdamdec1, showCategory=30)
```

## barplots GSEA Adamdec1
```{r barplots GSEA Adamdec1, fig.height=5, fig.width=12}
#select pahtways immune response and filter file
selpathw <- c("positive regulation of innate immune response", "toll-like receptor 4 signaling pathway", "regulation of NLRP3 inflammasome complex assembly", "RIG-I signaling pathway", "regulation of cytokine-mediated signaling pathway")

egoDSSAdamdec1_fil <- egoDSSAdamdec1%>% filter(egoDSSAdamdec1@result$Description %in% selpathw)

egoDSSAdamdec1_fil_2 <- pairwise_termsim(egoDSSAdamdec1_fil)
#make ggbarplot
p <- ggbarplot(egoDSSAdamdec1_fil_2@result, x = "Description", y = "Count", fill = "#B45B5C", color= "#B45B5C", sort.val = "asc", orientation = "horizontal")
p

#select pahtways epigenetic and filter file
selpathw <- c("negative regulation of gene expression, epigenetic", "epigenetic regulation of gene expression", "positive regulation of gene expression, epigenetic")

egoDSSAdamdec1_fil <- egoDSSAdamdec1%>% filter(egoDSSAdamdec1@result$Description %in% selpathw)

egoDSSAdamdec1_fil_2 <- pairwise_termsim(egoDSSAdamdec1_fil)
#make ggbarplot
p <- ggbarplot(egoDSSAdamdec1_fil_2@result, x = "Description", y = "Count", fill = "#B45B5C", color= "#B45B5C", sort.val = "asc", orientation = "horizontal")
p
```

## violin plots Adamdec1+
```{r violin plots Adamdec1+}
##positive regulation of gene expression, epigenetic
Idents(seuratA) <- seuratA$cond
VlnPlot(object = seuratA, features = "ENSMUSG00000086503.Xist", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000036940.Kdm1a", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000054203.Ifi205", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000024513.Mbd2", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000037487.Ubr5", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000030180.Kdm5a", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000026219.Trip12", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000078247.Airn", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000035851.Ythdc1", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000026313.Hdac4", pt.size= 0, cols= colcond) + theme(legend.position = "none")
##positive regulation of gene expression, epigenetic
VlnPlot(object = seuratA, features = "ENSMUSG00000002028.Kmt2a", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000054611.Kdm2a", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000022536.Glyr1", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000031660.Brd7", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000055024.Ep300", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000055024.Ep300", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000025019.Lcor", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000038025.Phf2", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000085715.Tsix", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000032187.Smarca4", pt.size= 1, cols= colcond) + theme(legend.position = "none")

##positive regulation of innate immune response
VlnPlot(object = seuratA, features = "ENSMUSG00000035356.Nfkbiz", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000024927.Rela", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000020400.Tnip1", pt.size= 1, cols= colcond) + theme(legend.position = "none")

VlnPlot(object = seuratA, features = "ENSMUSG00000061232.H2-K1", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000073409.H2-Q6", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000060550.H2-Q7", pt.size= 0, cols= colcond) + theme(legend.position = "none")

VlnPlot(object = seuratA, features = "ENSMUSG00000024349.Sting1", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000024737.Slc15a3", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000021270.Hsp90aa1", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000029826.Zc3hav1", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000033545.Znrf1", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000019850.Tnfaip3", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000021277.Traf3", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000037318.Traf3ip3", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000031639.Tlr3", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000074151.Nlrc5", pt.size= 1, cols= colcond) + theme(legend.position = "none")

##chemokines 
VlnPlot(object = seuratA, features = "ENSMUSG00000021508.Cxcl14", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000029371.Cxcl5", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000023078.Cxcl13", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000058427.Cxcl2", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000018920.Cxcl16", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000029417.Cxcl9", pt.size= 1, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000020676.Ccl11", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000035385.Ccl2", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000009185.Ccl8", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000035373.Ccl7", pt.size= 0, cols= colcond) + theme(legend.position = "none")
VlnPlot(object = seuratA, features = "ENSMUSG00000071005.Ccl19", pt.size= 1, cols= colcond) + theme(legend.position = "none")
```
## feature plots DE genes DSS
```{r feature plots DE DSS}
## plot feature
FeaturePlot(seuratFb, features = "ENSMUSG00000019850.Tnfaip3", cols = c("lightgrey", "#BE3144"), pt.size = 1)
FeaturePlot(seuratFb, features = "ENSMUSG00000024349.Sting1", cols = c("lightgrey", "#BE3144"), pt.size = 1)

```



## extract genes GSEA pigenetic regulation of gene expression
```{r extract genes pigenetic regulation of gene expression}
##epigenetic regulation of gene expression
ego1 <- dplyr::filter(egoDSSAdamdec1@result,egoDSSAdamdec1@result$Description=="epigenetic regulation of gene expression")
g1 <- ego1$geneID
g1_vector <- unlist(strsplit(g1, "/"))
g1_vector <- g1_vector[g1_vector != "a"]
g1_vector <- g1_vector[g1_vector != "Arb2a"]
```

## average heatmap genes pigenetic regulation of gene expression
```{r avg heatmap genespigenetic regulation of gene expression , fig.width=10, fig.height=17}
Idents(seuratFb) <- seuratFb$clusterName_cond
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^.*?_)","",celltype))
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(_.*$)","",celltype))
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
   # ordVec <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","IEC","Cycling")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=g1_vector)

levels(seurat)
colVec <- colclusterName
# colVec <- c(colPal, colPal, colPal)
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

## extract genes GSEA positive regulation of innate immune response
```{r extract genes positive regulation of innate immune response}
##epigenetic regulation of gene expression
ego1 <- dplyr::filter(egoDSSAdamdec1@result,egoDSSAdamdec1@result$Description=="positive regulation of innate immune response")
g1 <- ego1$geneID
g1_vector <- unlist(strsplit(g1, "/"))
g1_vector <- g1_vector[g1_vector != "Rigi"]
```

## average heatmap genes positive regulation of innate immune response
```{r avg heatmap genes positive regulation of innate immune response, fig.width=10, fig.height=25}
Idents(seuratFb) <- seuratFb$clusterName_cond
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^.*?_)","",celltype))
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(_.*$)","",celltype))
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
   # ordVec <- c("PdgfraloFb1","PdgfraloFb2","Trophocytes1","Trophocytes2","Telocytes/Fibro2","PdgfrahiFb","Myocytes","Glial","ICC1", "ICC2","Immun1","Immun2","IEC","Cycling")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=g1_vector)

levels(seurat)
colVec <- colclusterName
# colVec <- c(colPal, colPal, colPal)
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```


## GSEA crod Adamdec1
```{r GSEA crod Adamdec1, fig.width=10, fig.height=10}
## load DEGenesAdamdec1
DEGenesAdamdec <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenesAdamdec1_cond", header = TRUE, sep = "\t")

DEGenesAdamdec <- DEGenesAdamdec %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

DEcrodAdamdec1 <- DEGenesAdamdec %>% dplyr::filter(cluster == "crod")
##GSEA DSS
egocrodAdamdec1<- enrichGO(gene = unique(DEcrodAdamdec1$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egocrodAdamdec1 <- setReadable(egocrodAdamdec1, OrgDb = org.Mm.eg.db)
dotplot(egocrodAdamdec1, showCategory=30)
```

## GSEA untreated Adamdec1
```{r GSEA untreated Adamdec1, fig.width=10, fig.height=10}
## load DEGenesAdamdec1
DEGenesAdamdec <- read.delim("/Users/immbio/Desktop/Project/Angelina/ColonicFb/analysis/DEGenesAdamdec1_cond", header = TRUE, sep = "\t")

DEGenesAdamdec <- DEGenesAdamdec %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

DEuntreatedAdamdec1 <- DEGenesAdamdec %>% dplyr::filter(cluster == "untreated")
##GSEA DSS
egountreatedAdamdec1<- enrichGO(gene = unique(DEuntreatedAdamdec1$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egountreatedAdamdec1 <- setReadable(egountreatedAdamdec1, OrgDb = org.Mm.eg.db)
dotplot(egountreatedAdamdec1, showCategory=30)
```

## session info
```{r date and session info}
date()
sessionInfo()
```
